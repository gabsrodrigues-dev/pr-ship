#!/usr/bin/env bash

set -euo pipefail

PRSHIP_VERSION="1.0.2"
PRSHIP_CONFIG_DIR="${HOME}/.config/pr-ship"
PRSHIP_CONFIG_FILE="${PRSHIP_CONFIG_DIR}/config"
PRSHIP_LANG_DIR="/usr/share/pr-ship/lang"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ ! -d "$PRSHIP_LANG_DIR" ]]; then
  PRSHIP_LANG_DIR="${SCRIPT_DIR}/../lib/pr-ship/lang"
fi

UI_FILE="/usr/share/pr-ship/ui.sh"
if [[ ! -f "$UI_FILE" ]]; then
  UI_FILE="${SCRIPT_DIR}/../lib/pr-ship/ui.sh"
fi

source "$UI_FILE"
ui_init_colors

load_lang() {
  local lang="$1"
  local lang_file="${PRSHIP_LANG_DIR}/${lang}.sh"

  if [[ -f "$lang_file" ]]; then
    source "$lang_file"
    return 0
  fi

  local base_lang="${lang%%_*}"
  for f in "${PRSHIP_LANG_DIR}"/${base_lang}*.sh; do
    if [[ -f "$f" ]]; then
      source "$f"
      return 0
    fi
  done

  source "${PRSHIP_LANG_DIR}/en.sh"
}

load_config() {
  PRSHIP_OWNER=""
  PRSHIP_DEFAULT_HEAD="development"
  PRSHIP_DEFAULT_BASE="sandbox"
  PRSHIP_TITLE=""
  PRSHIP_BODY=""
  PRSHIP_LANG=""

  if [[ -f "$PRSHIP_CONFIG_FILE" ]]; then
    source "$PRSHIP_CONFIG_FILE"
  fi
}

detect_system_lang() {
  local sys_lang="${LANG:-${LC_ALL:-en_US.UTF-8}}"
  echo "${sys_lang%%.*}"
}

show_help() {
  echo "pr-ship v${PRSHIP_VERSION}"
  echo ""
  echo "Usage: pr-ship <repo> [head] [base] [--title \"...\"] [--body \"...\"]"
  echo ""
  echo "  <repo>     Repository name (owner/repo or just repo)"
  echo "  [head]     Source branch (default: ${PRSHIP_DEFAULT_HEAD})"
  echo "  [base]     Target branch (default: ${PRSHIP_DEFAULT_BASE})"
  echo "  --title    PR title"
  echo "  --body     PR body"
  echo "  --setup    Run interactive setup"
  echo "  --version  Show version"
  echo "  --help     Show this help"
}

run_setup() {
  local sys_lang
  sys_lang=$(detect_system_lang)

  local selected_lang="en"
  local available_langs=()
  local lang_names=()

  for f in "${PRSHIP_LANG_DIR}"/*.sh; do
    [[ -f "$f" ]] || continue
    local fname
    fname=$(basename "$f" .sh)
    available_langs+=("$fname")
    lang_names+=("$fname")
  done

  for al in "${available_langs[@]}"; do
    if [[ "$sys_lang" == "$al" || "${sys_lang%%_*}" == "${al%%_*}" ]]; then
      selected_lang="$al"
      break
    fi
  done

  load_lang "$selected_lang"

  ui_clear_stage
  ui_header "pr-ship ${MSG_STAGE_SETUP}"
  ui_kv "${MSG_SETUP_LANG_DETECT}" "${sys_lang} -> ${selected_lang}"
  read -rp "${MSG_SETUP_LANG_CONFIRM} " lang_confirm

  if [[ "$lang_confirm" =~ ^[nN] ]]; then
    echo ""
    ui_info "${MSG_SETUP_LANG_SELECT}:"
    for i in "${!lang_names[@]}"; do
      echo "  $((i + 1)). ${lang_names[$i]}"
    done
    read -rp "${MSG_SETUP_LANG_CHOOSE}: " lang_choice

    if [[ "$lang_choice" =~ ^[0-9]+$ ]] && (( lang_choice >= 1 && lang_choice <= ${#lang_names[@]} )); then
      selected_lang="${lang_names[$((lang_choice - 1))]}"
      load_lang "$selected_lang"
    else
      ui_warn "${MSG_SETUP_LANG_FALLBACK}"
      selected_lang="en"
      load_lang "en"
    fi
  fi

  ui_clear_stage
  ui_header "pr-ship ${MSG_STAGE_SETUP}"
  ui_info "${MSG_SETUP_WELCOME}"
  echo ""

  read -rp "${MSG_SETUP_OWNER}: " setup_owner
  read -rp "${MSG_SETUP_HEAD}: " setup_head
  read -rp "${MSG_SETUP_BASE}: " setup_base
  read -rp "${MSG_SETUP_TITLE}: " setup_title
  read -rp "${MSG_SETUP_BODY}: " setup_body

  setup_head="${setup_head:-development}"
  setup_base="${setup_base:-sandbox}"

  mkdir -p "$PRSHIP_CONFIG_DIR"

  cat > "$PRSHIP_CONFIG_FILE" <<EOF
PRSHIP_OWNER="${setup_owner}"
PRSHIP_DEFAULT_HEAD="${setup_head}"
PRSHIP_DEFAULT_BASE="${setup_base}"
PRSHIP_TITLE="${setup_title}"
PRSHIP_BODY="${setup_body}"
PRSHIP_LANG="${selected_lang}"
EOF

  echo ""
  ui_ok "${MSG_SETUP_DONE}"
}

main() {
  load_config

  if [[ -n "$PRSHIP_LANG" ]]; then
    load_lang "$PRSHIP_LANG"
  else
    load_lang "$(detect_system_lang)"
  fi

  if ! command -v gh &>/dev/null; then
    ui_err "${MSG_ERROR_GH}"
    exit 1
  fi

  local input_repo=""
  local head=""
  local base=""
  local title=""
  local body=""
  local positional=()

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --setup)
        run_setup
        return 0
        ;;
      --help|-h)
        show_help
        return 0
        ;;
      --version|-v)
        echo "pr-ship v${PRSHIP_VERSION}"
        return 0
        ;;
      --title)
        title="$2"
        shift 2
        ;;
      --body)
        body="$2"
        shift 2
        ;;
      *)
        positional+=("$1")
        shift
        ;;
    esac
  done

  input_repo="${positional[0]:-}"
  head="${positional[1]:-$PRSHIP_DEFAULT_HEAD}"
  base="${positional[2]:-$PRSHIP_DEFAULT_BASE}"

  if [[ -z "$input_repo" ]]; then
    ui_err "${MSG_ERROR_REPO}"
    return 1
  fi

  local repo
  if [[ "$input_repo" != */* ]]; then
    if [[ -z "$PRSHIP_OWNER" ]]; then
      ui_err "${MSG_ERROR_REPO}"
      ui_info "Run: pr-ship --setup"
      return 1
    fi
    repo="${PRSHIP_OWNER}/${input_repo}"
  else
    repo="$input_repo"
  fi

  local owner="${repo%%/*}"
  local repo_name="${repo##*/}"

  title="${title:-${PRSHIP_TITLE:-$MSG_TITLE_DEFAULT}}"
  body="${body:-${PRSHIP_BODY:-${MSG_BODY_DEFAULT} — by ${owner}}}"

  ui_clear_stage
  ui_header "pr-ship ${MSG_STAGE_CREATE_PR}"
  ui_kv "${MSG_REPO}" "${repo}"
  ui_kv "${MSG_HEAD_BRANCH}" "${head}"
  ui_kv "${MSG_BASE_BRANCH}" "${base}"
  echo ""
  ui_info "${MSG_CREATING_PR}"

  local pr_number
  pr_number=$(gh api "repos/${owner}/${repo_name}/pulls" \
    -f title="${title}" \
    -f head="${head}" \
    -f base="${base}" \
    -f body="${body}" \
    --jq .number 2>/dev/null)

  if [[ -z "$pr_number" ]]; then
    ui_err "${MSG_ERROR_PR}"
    return 1
  fi

  echo ""
  ui_ok "${MSG_PR_CREATED}"
  ui_kv "${MSG_PR_LINK}" "https://github.com/${repo}/pull/${pr_number}"

  ui_clear_stage
  ui_header "pr-ship ${MSG_STAGE_MERGE}"
  ui_kv "${MSG_REPO}" "${repo}"
  ui_kv "PR" "#${pr_number}"
  echo ""
  ui_info "${MSG_MERGING}"
  gh api "repos/${owner}/${repo_name}/pulls/${pr_number}/merge" \
    -X PUT \
    -f merge_method=merge \
    --jq "\"✅ ${MSG_MERGE_DONE}: \" + (.merged | tostring)" || {
      ui_err "${MSG_ERROR_MERGE}"
      return 1
    }

  echo ""
  ui_clear_stage
  ui_header "pr-ship ${MSG_STAGE_DONE}"
  ui_ok "${MSG_FINISHED}"
}

main "$@"
